rule featureCounts:
    input:
        bam="tmp/{aligner}/{reference}.bam",
        bai="tmp/{aligner}/{reference}.bam.bai",
        ref_gtf=lambda wc: config["data_paths"]["references"][wc.reference]["gtf"],
    output:
        counts="output/counts/{aligner}_{reference}.counts.tsv",
    log:
        "output/counts/{aligner}_{reference}.log",
    resources:
        runtime=2880,
        mem_gb=120,
    threads: 64
    conda: "../envs/subread.yml"
    shell:
        "( featureCounts"
        "   -p"
        "   -T {threads}"
        "   -a {input.ref_gtf}"
        "   -t exon"
        "   -g gene_id"
        "   -o {output.counts}"
        "   --countReadPairs"
        "   --byReadGroup"
        "   -M {input.bam}"
        " ) &> {log}"

